---
title: "`nihexporter` interactive analysis"
author: "Jay Hesselberth"
date: "March 14, 2015"
output: html_document
runtime: shiny
---

```{r load.libs, echo = FALSE, message = FALSE, warning = FALSE}
library(dplyr)
library(scales)
library(ggplot2)
library(lubridate)
library(nihexporter)
```

# Funding trends

This interactive plot shows total grant costs for selected activities (i.e., grant types) in specific [NIH institutes](http://grants.nih.gov/grants/acronym_list.htm)

```{r funding_trends, echo=FALSE}
grant_types <- projects %>%
  select(activity) %>%
  distinct() %>%
  sapply(as.character) %>% as.vector

min_fiscal_year <- as.integer(min(projects$fiscal.year))
max_fiscal_year <- as.integer(max(projects$fiscal.year))

inputPanel(
  selectInput("nih_institutes", label = "Institute:",
              choices = nih.institutes, selected = c('GM','CA','AI'), 
              multiple = TRUE),
  selectInput("activities", label = "Activity:",
              choices = grant_types, selected = c('R01','P01'),
              multiple = TRUE),
  sliderInput("fiscal_years", label = "Fiscal years:",
              min = min_fiscal_year,
              max = max_fiscal_year,
              value = c(2010, 2014),
              sep = "",
              step = 1),
  submitButton("Submit")
)

renderPlot({
  
  inst_costs <- projects %>%
    filter(institute %in% input$nih_institutes &
           activity %in% input$activities &
           fiscal.year >= input$fiscal_years[1] &
             fiscal.year <= input$fiscal_years[2]) %>%
    select(project.num, institute, activity, fiscal.year, total.cost) %>%
    group_by(project.num, activity, institute, fiscal.year) %>%
    summarize(grant.cost = sum(total.cost, na.rm = TRUE))
  
  ggplot(inst_costs, aes(x = factor(fiscal.year),
                         y = grant.cost, 
                         fill = activity)) +
    geom_boxplot(outlier.size = 0.2) + 
    facet_wrap(~ institute) + 
    scale_y_log10(limits = c(9e4, 1e7),
                  labels = trans_format("log10", math_format(10^.x))) + 
    annotation_logticks(sides = "l",
                        scaled = TRUE) +
    scale_fill_brewer(palette="Dark2") +
    xlab('') +
    ylab('Total grant dollars, log-scaled') +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90))  
})
```



